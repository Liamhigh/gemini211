workflows:
  android_release:
    name: Verum Omnis â€” Fast APK
    instance_type: linux_x2
    max_build_duration: 45

    scripts:
      - name: Build & package Android
        script: |
          set -euo pipefail

          echo "== 1) Install deps =="
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps
          npm install @capacitor/core @capacitor/cli @capacitor/android --save --legacy-peer-deps

          echo "== 2) Build web =="
          npm run build || npx vite build || true
          rm -rf www
          [ -d dist ] && cp -r dist www || { mkdir -p www && echo '<h1>Verum</h1>' > www/index.html; }

          echo "== 3) Create capacitor.config.json =="
          cat > capacitor.config.json <<'JSON'
          {
            "appId": "foundation.verum.global",
            "appName": "Verum Omnis",
            "webDir": "www",
            "bundledWebRuntime": false
          }
          JSON
          cat capacitor.config.json

          echo "== 4) Add/sync Android =="
          if [ -d android ] && [ ! -f android/settings.gradle ]; then
            echo "Removing empty android folder..."
            rm -rf android
          fi
          npx cap add android || echo "android already added"
          npx cap sync android

          echo "== 5) Build APK =="
          cd android
          chmod +x gradlew || true
          ./gradlew --no-daemon :app:assembleDebug

    artifacts:
      - android/app/build/outputs/**/*.apk